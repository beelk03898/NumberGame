<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO SUM - Soft Glass & Ranking</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Noto+Sans+KR:wght@400;700&display=swap');

        body { margin: 0; background: #000; color: white; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* 1. 휴대폰 비율로 수정 */
        #game-outer { 
            position: relative; 
            width: 95vw; 
            max-width: 430px; 
            aspect-ratio: 9 / 16; 
            background: #0f0f0f; 
            border: 4px solid #222; 
            overflow: hidden; 
            box-shadow: 0 0 50px rgba(0,0,0,1); 
            transition: background 0.3s; 
        }

        .layer { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.5s ease-in-out; }

        #logo-screen { background: #000; z-index: 3000; pointer-events: none; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 900; color: #00ffcc; opacity: 0; animation: logo-fade 2.5s forwards; }

        #home-screen { background: radial-gradient(circle, #1a1a1a, #000); z-index: 2000; opacity: 0; pointer-events: none; }
        #home-screen.active { opacity: 1; pointer-events: auto; }
        .game-title { font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(0,255,204,0.3); margin-bottom: 5px; }
        
        .nickname-input { background: rgba(255,255,255,0.1); border: 1px solid #00ffcc; border-radius: 5px; color: #fff; padding: 10px; text-align: center; font-family: 'Orbitron'; margin-bottom: 20px; outline: none; width: 200px; }

        #billboard { width: 280px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 30px; cursor: pointer; transition: 0.3s; }
        #billboard:hover { background: rgba(255,255,255,0.1); border-color: #00ffcc; }
        .ranking-title { font-family: 'Orbitron'; font-size: 1rem; color: #00ffcc; margin-bottom: 10px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .ranking-list { list-style: none; padding: 0; margin: 0; font-family: 'Orbitron'; font-size: 0.9rem; }
        .ranking-item { display: flex; justify-content: space-between; padding: 3px 0; color: #ccc; }
        .ranking-item.top { color: #ffd700; font-weight: bold; }

        #rank-popup { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; 
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        #rank-popup.active { opacity: 1; pointer-events: auto; }
        .rank-box { 
            background: #111; border: 2px solid #00ffcc; padding: 25px; border-radius: 20px; 
            width: 80%; height: 70%; display: flex; flex-direction: column;
        }
        .full-rank-scroll { flex: 1; overflow-y: auto; margin: 15px 0; padding-right: 5px; }
        .full-rank-scroll::-webkit-scrollbar { width: 4px; }
        .full-rank-scroll::-webkit-scrollbar-thumb { background: #00ffcc; border-radius: 2px; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; width: 220px; }
        .main-btn { padding: 12px; font-size: 1.1rem; cursor: pointer; background: transparent; border: 2px solid #00ffcc; color: #00ffcc; border-radius: 50px; font-weight: bold; transition: 0.3s; font-family: 'Orbitron', sans-serif; outline: none; }
        .main-btn:hover { background: #00ffcc; color: #000; box-shadow: 0 0 20px #00ffcc; }

        #howto-popup { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        #howto-popup.active { opacity: 1; pointer-events: auto; }
        .howto-box { 
            background: #222; border: 2px solid #00ffcc; padding: 40px 30px; border-radius: 20px; 
            box-shadow: 0 0 30px rgba(0,255,204,0.2); transform: translateY(20px); transition: transform 0.4s ease;
            width: 80%;
        }
        #howto-popup.active .howto-box { transform: translateY(0); }
        .howto-box p { font-size: 1.1rem; line-height: 1.8; color: #fff; margin-bottom: 30px; word-break: keep-all; font-weight: 500; }

        #game-ui { position: absolute; top: 0; width: 100%; height: 75px; background: rgba(40, 40, 40, 0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; justify-content: center; z-index: 1500; transform: translateY(-100%); transition: 0.5s; padding: 5px 15px; box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #game-ui.active { transform: translateY(0); }
        
        .ui-top { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px; }
        #fever-bar-container { width: 100%; height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        #fever-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff99ff, #99ffff); transition: width 0.1s linear; }

        #game-container { position: relative; width: 100%; height: 100%; background: transparent; overflow: hidden; }
        
        .pause-btn-group { display: flex; gap: 8px; align-items: center; }
        .pause-btn-style { cursor: pointer; background: none; border: 1px solid #777; color: #fff; border-radius: 4px; padding: 2px 0; width: 65px; text-align: center; font-family: 'Orbitron'; font-size: 0.7rem; }
        #home-btn { display: none; border-color: #ff4444; color: #ff4444; width: 55px; }

        .ball { 
            position: absolute; width: 52px; height: 52px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; cursor: pointer; user-select: none; font-size: 1.2rem; z-index: 5; box-sizing: border-box; transition: transform 0.1s;
            backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: inset -5px -5px 12px rgba(0,0,0,0.2), inset 5px 5px 12px rgba(255,255,255,0.4), 0 8px 15px rgba(0,0,0,0.3);
            color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .ball::before { content: ''; position: absolute; top: 10%; left: 15%; width: 45%; height: 30%; background: linear-gradient(to bottom, rgba(255,255,255,0.7), transparent); border-radius: 50%; pointer-events: none; }
        .ball.selected { transform: scale(1.15); z-index: 100 !important; box-shadow: 0 0 25px rgba(255,255,255,0.6), inset 0 0 10px rgba(255,255,255,0.5); border: 2px solid #fff; }
        
        .ball.gold { background: radial-gradient(circle at 30% 30%, rgba(255, 245, 180, 0.6), rgba(255, 215, 0, 0.4)) !important; border-color: #ffd700; color: #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .ball.bomb { background: radial-gradient(circle at 30% 30%, rgba(100, 100, 100, 0.6), rgba(20, 20, 20, 0.7)) !important; border-color: #ff6b6b; color: #ff6b6b; }
        .ball.freeze { background: radial-gradient(circle at 30% 30%, rgba(200, 255, 255, 0.6), rgba(0, 223, 255, 0.4)) !important; border-color: #00dfff; }
        .ball.heavy { background: radial-gradient(circle at 30% 30%, rgba(180, 150, 255, 0.6), rgba(75, 0, 130, 0.4)) !important; border-color: #b19cd9; animation: heavy-pulse 0.5s infinite alternate; }
        .ball.fog { background: radial-gradient(circle at 30% 30%, rgba(150, 150, 150, 0.4), rgba(50, 50, 50, 0.4)) !important; color: #e0b0ff; border: 1px dashed #e0b0ff; }
        .ball.lucky { border: 3px solid rgba(255, 215, 0, 0.8) !important; box-shadow: 0 0 20px rgba(255,215,0,0.4) !important; animation: lucky-glow 0.6s infinite alternate; }

        .melting { transition: transform 0.6s cubic-bezier(0.55, 0.055, 0.675, 0.19), opacity 0.5s ease !important; transform: translateY(60px) scaleY(0.1) scaleX(1.3) !important; opacity: 0 !important; pointer-events: none !important; z-index: 1 !important; }
        .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 100; }
        #sum-display { font-size: 18px; font-weight: bold; font-family: 'Orbitron'; transition: 0.1s; }
        .dead-line { position: absolute; bottom: 0; width: 100%; height: 10px; background: linear-gradient(to top, rgba(255, 68, 68, 0.5), transparent); z-index: 10; }

        @keyframes logo-fade { 0% { opacity: 0; transform: scale(0.8); } 40%, 70% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.1); } }
        @keyframes heavy-pulse { from { box-shadow: 0 0 5px #b19cd9; } to { box-shadow: 0 0 15px #ff4b5c; } }
        @keyframes lucky-glow { from { transform: scale(1); } to { transform: scale(1.08); } }
        @keyframes fever-bg { from { background: #0f0f0f; } to { background: #1a0f1a; } }
        .fever-active { animation: fever-bg 0.5s infinite alternate !important; }
        .warning-flash { animation: bg-flash 0.5s infinite alternate; }
        @keyframes bg-flash { from { background: #0f0f0f; } to { background: #2a1515; } }
    </style>
</head>
<body>

<div id="game-outer">
    <div id="logo-screen" class="layer"><div class="logo-text">ZERO SUM</div></div>
    
    <div id="home-screen" class="layer">
        <div class="game-title">ZERO SUM</div>
        
        <div id="billboard" onclick="showFullRank(true)">
            <div class="ranking-title">TOP 3 RANKING</div>
            <ul class="ranking-list" id="rank-list"></ul>
            <div style="font-size: 0.6rem; text-align: center; color: #555; margin-top: 5px;">CLICK TO VIEW ALL</div>
        </div>

        <input type="text" id="player-name" class="nickname-input" placeholder="ENTER NICKNAME" maxlength="10">

        <div class="btn-group">
            <button class="main-btn" onclick="goToGame()">START GAME</button>
            <button class="main-btn" onclick="showHowTo(true)">HOW TO</button>
        </div>
    </div>

    <div id="rank-popup">
        <div class="rank-box">
            <div class="ranking-title">TOP 100 RANKING</div>
            <div class="full-rank-scroll">
                <ul class="ranking-list" id="full-rank-list"></ul>
            </div>
            <center><button class="main-btn" style="width:120px; padding:10px; font-size:1.1rem;" onclick="showFullRank(false)">CLOSE</button></center>
        </div>
    </div>

    <div id="howto-popup">
        <div class="howto-box">
            <p>합을 0으로 만드세요.<br>바닥에 닿으면 끝납니다.</p>
            <center><button class="main-btn" style="width:120px; padding:10px; font-size:1.1rem;" onclick="showHowTo(false)">OK</button></center>
        </div>
    </div>

    <div id="game-ui">
        <div class="ui-top">
            <div style="font-family:'Orbitron'; font-size: 0.8rem;">SC: <span id="score">0</span></div>
            <div id="sum-display">SUM: 0</div>
            <div class="pause-btn-group">
                <button id="home-btn" onclick="quitToHome()" class="pause-btn-style">HOME</button>
                <button id="pauseBtn" onclick="togglePause()" class="pause-btn-style">PAUSE</button>
            </div>
        </div>
        <div id="fever-bar-container"><div id="fever-bar"></div></div>
    </div>
    <div id="game-container"><div class="dead-line"></div></div>
</div>

<script>
    const screens = { 
        outer: document.getElementById('game-outer'),
        logo: document.getElementById('logo-screen'), 
        home: document.getElementById('home-screen'), 
        ui: document.getElementById('game-ui'), 
        howto: document.getElementById('howto-popup'),
        rankList: document.getElementById('rank-list'),
        fullRankList: document.getElementById('full-rank-list'),
        rankPopup: document.getElementById('rank-popup'),
        nameInput: document.getElementById('player-name')
    };
    const scoreEl = document.getElementById('score'), sumEl = document.getElementById('sum-display'), 
          container = document.getElementById('game-container'), feverBar = document.getElementById('fever-bar');
    
    let score = 0, selectedBalls = [], balls = [], gameActive = false, isPaused = false;
    let baseSpeed = 0.3, spawnRate = 1600, lastSpawn = 0, combo = 0, lastPopTime = 0;
    let isFrozen = false, isFoggy = false, freezeTimer = null, fogTimer = null;
    
    let feverGauge = 0, isFever = false, feverEndTime = 0;
    
    // 2. 유동적 높이 계산을 위해 DEAD_LINE_Y 초기값만 설정
    const FEVER_MAX = 100, FEVER_DURATION = 5000, BALL_SIZE = 52, COMBO_TIMEOUT = 3000;
    let DEAD_LINE_Y = screens.outer.offsetHeight - 75;

    // 화면 리사이즈 시 데드라인 재계산
    window.addEventListener('resize', () => { DEAD_LINE_Y = screens.outer.offsetHeight - 75; });

    let playerName = localStorage.getItem('zeroSumNick') || "";
    screens.nameInput.value = playerName;
    updateBillboard();

    setTimeout(() => { screens.logo.style.display = 'none'; screens.home.classList.add('active'); }, 2500);

    function showHowTo(on) { 
        if(on) { screens.howto.classList.add('active'); playSound(500, 'sine', 0.1); } 
        else { screens.howto.classList.remove('active'); }
    }

    function showFullRank(on) {
        if(on) { screens.rankPopup.classList.add('active'); playSound(400, 'sine', 0.1); }
        else { screens.rankPopup.classList.remove('active'); }
    }
    
    function goToGame() { 
        playerName = screens.nameInput.value.trim() || "Player";
        localStorage.setItem('zeroSumNick', playerName);
        screens.home.classList.remove('active'); 
        screens.ui.classList.add('active'); 
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
        resetGame(); 
        gameActive = true; 
        requestAnimationFrame(update); 
    }

    function updateBillboard() {
        let ranks = JSON.parse(localStorage.getItem('zeroSumRanks')) || [];
        screens.rankList.innerHTML = ranks.length ? "" : "<li style='text-align:center; opacity:0.5;'>NO DATA</li>";
        ranks.slice(0, 3).forEach((data, idx) => {
            const li = document.createElement('li');
            li.className = `ranking-item ${idx === 0 ? 'top' : ''}`;
            li.innerHTML = `<span>${idx + 1}. ${data.name}</span> <span>${data.score}</span>`;
            screens.rankList.appendChild(li);
        });
        screens.fullRankList.innerHTML = ranks.length ? "" : "<li style='text-align:center; opacity:0.5;'>NO DATA</li>";
        ranks.slice(0, 100).forEach((data, idx) => {
            const li = document.createElement('li');
            li.className = `ranking-item ${idx === 0 ? 'top' : ''}`;
            li.innerHTML = `<span>${idx + 1}. ${data.name}</span> <span>${data.score}</span>`;
            screens.fullRankList.appendChild(li);
        });
    }

    function saveScore(finalScore) {
        if (finalScore <= 0) return;
        let ranks = JSON.parse(localStorage.getItem('zeroSumRanks')) || [];
        const existing = ranks.find(r => r.name === playerName);
        if (existing) { if (finalScore > existing.score) existing.score = finalScore; else return; } 
        else { ranks.push({ name: playerName, score: finalScore }); }
        ranks.sort((a, b) => b.score - a.score);
        ranks = ranks.slice(0, 100);
        localStorage.setItem('zeroSumRanks', JSON.stringify(ranks));
        updateBillboard();
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration) {
        if (audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function createParticle(x, y, color) {
        for (let i = 0; i < 8; i++) {
            const p = document.createElement('div');
            p.className = 'particle'; p.style.backgroundColor = color;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            container.appendChild(p);
            const angle = Math.random() * Math.PI * 2, velocity = 2 + Math.random() * 4;
            let px = x, py = y, vx = Math.cos(angle) * velocity, vy = Math.sin(angle) * velocity;
            const pAnim = () => {
                vx *= 0.95; vy *= 0.95; px += vx; py += vy;
                p.style.left = px + 'px'; p.style.top = py + 'px';
                p.style.opacity = parseFloat(p.style.opacity || 1) - 0.02;
                if (parseFloat(p.style.opacity) > 0) requestAnimationFrame(pAnim); else p.remove();
            };
            requestAnimationFrame(pAnim);
        }
    }

    function getRandomValue() {
        const range = Math.min(15, 7 + Math.floor(score / 3000));
        const fieldSum = balls.reduce((s, b) => s + (typeof b.val === 'number' ? b.val : 0), 0);
        let val;
        if (fieldSum < -8 && Math.random() < 0.7) val = Math.floor(Math.random() * range) + 1;
        else if (fieldSum > 8 && Math.random() < 0.7) val = Math.floor(Math.random() * range) - range;
        else val = Math.floor(Math.random() * (range * 2 + 1)) - range;
        return val === 0 ? getRandomValue() : val;
    }

    function createBall() {
        let type = 'normal', val, isLucky = false;
        const rand = Math.random();
        if (rand < 0.015) type = 'gold';
        else if (rand < 0.03) type = 'bomb';
        else if (rand < 0.045) type = 'freeze';
        else if (rand < 0.075) type = 'heavy';
        else if (rand < 0.105) type = 'fog';
        
        if (type === 'normal' || type === 'heavy') {
            if (Math.random() < 0.07) isLucky = true; 
            val = getRandomValue();
        } else {
            val = type === 'gold' ? '★' : (type === 'bomb' ? 'B' : (type === 'freeze' ? 'F' : '?'));
        }

        const ball = document.createElement('div'); 
        ball.className = `ball ${type} ${isLucky ? 'lucky' : ''}`; 
        
        let currentDisplayVal = (isFever && (type === 'normal' || type === 'heavy')) ? (val > 0 ? 1 : -1) : val;

        // 3. 공 생성 시 가로 범위를 현재 화면 너비에 맞게 계산
        const ballObj = { 
            el: ball, val: currentDisplayVal, originalVal: val, type: type, isLucky: isLucky, 
            x: Math.random() * (screens.outer.clientWidth - BALL_SIZE), y: -60, vx: (Math.random()-0.5)*0.3, 
            speed: (baseSpeed + (score / 4000)) * (type === 'heavy' ? 1.7 : 1.0) + Math.random()*0.2, isMelting: false 
        };
        
        updateBallText(ball, ballObj.val, type);
        setBallColor(ball, ballObj.val, type, isLucky);
        container.appendChild(ball); balls.push(ballObj);
        ball.onmousedown = (e) => { e.preventDefault(); if(!ballObj.isMelting) toggleSelect(ballObj); };
    }

    function setBallColor(el, val, type, isLucky) {
        if (type === 'normal' || type === 'heavy') {
            if (isLucky) el.style.background = "radial-gradient(circle at 30% 30%, rgba(255, 235, 150, 0.6), rgba(218, 165, 32, 0.4))";
            else {
                if (val > 0) { el.style.background = "radial-gradient(circle at 30% 30%, rgba(255, 180, 190, 0.6), rgba(255, 100, 120, 0.4))"; el.style.borderColor = "rgba(255, 150, 160, 0.5)"; }
                else { el.style.background = "radial-gradient(circle at 30% 30%, rgba(180, 210, 255, 0.6), rgba(100, 150, 255, 0.4))"; el.style.borderColor = "rgba(150, 180, 255, 0.5)"; }
            }
        }
    }

    function updateBallText(el, val, type) {
        if (isFoggy && (type === 'normal' || type === 'heavy')) el.innerText = '?';
        else el.innerText = typeof val === 'number' ? (val > 0 ? `+${val}` : val) : val;
    }

    function toggleSelect(ballObj) {
        if (!gameActive || isPaused) return;
        if (ballObj.type === 'gold') { activateGold(ballObj); return; }
        if (ballObj.type === 'bomb') { activateBomb(ballObj); return; }
        if (ballObj.type === 'freeze') { activateFreeze(ballObj); return; }
        if (ballObj.type === 'fog') { activateFog(ballObj); return; }
        if (selectedBalls.includes(ballObj)) { selectedBalls = selectedBalls.filter(b => b !== ballObj); ballObj.el.classList.remove('selected'); playSound(300, 'sine', 0.1); }
        else { selectedBalls.push(ballObj); ballObj.el.classList.add('selected'); playSound(600, 'sine', 0.1); }
        updateSumDisplay();
    }

    function updateSumDisplay() {
        const sum = selectedBalls.reduce((s, b) => s + b.val, 0);
        sumEl.innerText = `SUM: ${selectedBalls.length === 0 ? 0 : sum}`;
        if (selectedBalls.length > 0) { sumEl.style.color = sum > 0 ? "#ffb4be" : (sum < 0 ? "#b4d2ff" : "#00ffcc"); } 
        else { sumEl.style.color = "#00ffcc"; }
        if (selectedBalls.length > 0 && sum === 0) popBalls();
    }

    function popBalls(isGold = false) {
        const now = Date.now();
        if (now - lastPopTime < COMBO_TIMEOUT) combo++; else combo = 1;
        lastPopTime = now;
        if (!isGold) {
            let hasLucky = selectedBalls.some(b => b.isLucky);
            score += (selectedBalls.length * 10) * combo * (hasLucky ? 5 : 1);
            if (!isFever) {
                feverGauge = Math.min(FEVER_MAX, feverGauge + selectedBalls.length * 5);
                feverBar.style.width = feverGauge + '%';
                if (feverGauge >= FEVER_MAX) startFever();
            }
            const lastB = selectedBalls[selectedBalls.length - 1];
            if (combo > 1) showComboUI(combo, lastB.x, lastB.y);
            selectedBalls.forEach(b => { createParticle(b.x + BALL_SIZE/2, b.y + BALL_SIZE/2, b.isLucky ? '#ffd700' : (b.val > 0 ? '#ffb4be' : '#b4d2ff')); b.el.remove(); balls = balls.filter(allB => allB !== b); });
            selectedBalls = []; 
        } else { score += (selectedBalls.length + 1) * 20; }
        scoreEl.innerText = score;
        updateSumDisplay();
    }

    function startFever() {
        isFever = true; feverEndTime = Date.now() + FEVER_DURATION;
        screens.outer.classList.add('fever-active'); playSound(1200, 'square', 0.5);
        balls.forEach(b => { if (!b.isMelting && (b.type === 'normal' || b.type === 'heavy')) { b.val = b.val > 0 ? 1 : -1; updateBallText(b.el, b.val, b.type); setBallColor(b.el, b.val, b.type, b.isLucky); } });
        updateSumDisplay();
    }

    function endFever() {
        isFever = false; feverGauge = 0; feverBar.style.width = '0%';
        screens.outer.classList.remove('fever-active');
        balls.forEach(b => { if (!b.isMelting && (b.type === 'normal' || b.type === 'heavy')) { b.val = b.originalVal; updateBallText(b.el, b.val, b.type); setBallColor(b.el, b.val, b.type, b.isLucky); } });
        selectedBalls = []; updateSumDisplay();
    }

    function showComboUI(count, x, y) {
        const comboText = document.createElement('div');
        comboText.innerText = `${count} COMBO!`;
        comboText.style.cssText = `position: absolute; left: ${x}px; top: ${y}px; font-family: 'Orbitron'; font-size: 1.8rem; color: #00ffcc; font-weight: 900; pointer-events: none; z-index: 2000; text-shadow: 0 0 10px #00ffcc; transition: all 0.8s ease-out;`;
        container.appendChild(comboText);
        setTimeout(() => { comboText.style.transform = 'translateY(-60px) scale(1.3)'; comboText.style.opacity = '0'; }, 50);
        setTimeout(() => comboText.remove(), 850);
    }

    function activateGold(ballObj) {
        playSound(800, 'square', 0.2); createParticle(ballObj.x + BALL_SIZE/2, ballObj.y + BALL_SIZE/2, '#ffd700');
        ballObj.el.remove(); balls = balls.filter(b => b !== ballObj);
        selectedBalls.forEach(b => { createParticle(b.x + BALL_SIZE/2, b.y + BALL_SIZE/2, b.val > 0 ? '#ffb4be' : '#b4d2ff'); b.el.remove(); balls = balls.filter(allB => allB !== b); });
        popBalls(true); selectedBalls = [];
    }

    function activateBomb(ballObj) {
        ballObj.el.classList.add('selected');
        playSound(200, 'sawtooth', 0.3);
        createParticle(ballObj.x + BALL_SIZE/2, ballObj.y + BALL_SIZE/2, '#ff6b6b');
        setTimeout(() => {
            ballObj.el.remove(); balls = balls.filter(b => b !== ballObj);
            for(let i = 0; i < 3; i++) {
                if(balls.length > 0) {
                    const target = balls[Math.floor(Math.random() * balls.length)];
                    createParticle(target.x + BALL_SIZE/2, target.y + BALL_SIZE/2, target.val > 0 ? '#ffb4be' : '#b4d2ff');
                    target.el.remove(); balls = balls.filter(b => b !== target);
                    selectedBalls = selectedBalls.filter(b => b !== target);
                }
            }
            score += 50; scoreEl.innerText = score; updateSumDisplay();
        }, 120);
    }

    function activateFreeze(ballObj) {
        ballObj.el.classList.add('selected');
        playSound(1000, 'sine', 0.5);
        createParticle(ballObj.x + BALL_SIZE/2, ballObj.y + BALL_SIZE/2, '#00dfff');
        setTimeout(() => {
            ballObj.el.remove(); balls = balls.filter(b => b !== ballObj);
            isFrozen = true; if (freezeTimer) clearTimeout(freezeTimer);
            freezeTimer = setTimeout(() => { isFrozen = false; }, 5000);
        }, 120);
    }

    function activateFog(ballObj) { playSound(150, 'sine', 0.8); ballObj.el.remove(); balls = balls.filter(b => b !== ballObj); isFoggy = true; balls.forEach(b => updateBallText(b.el, b.val, b.type)); if(fogTimer) clearTimeout(fogTimer); fogTimer = setTimeout(() => { isFoggy = false; balls.forEach(b => updateBallText(b.el, b.val, b.type)); }, 3000); }

    function update(time) {
        if (!gameActive || isPaused) return;
        if (isFever) { let remaining = feverEndTime - Date.now(); feverGauge = (remaining / FEVER_DURATION) * 100; feverBar.style.width = feverGauge + '%'; if (remaining <= 0) endFever(); }
        if (time - lastSpawn > (isFever ? spawnRate/2 : spawnRate)) { createBall(); lastSpawn = time; }
        let nearDeadLine = false;
        for (let i = balls.length - 1; i >= 0; i--) {
            let b1 = balls[i]; if (b1.isMelting) continue;
            let moveStep = isFrozen ? b1.speed * 0.2 : b1.speed;
            b1.y += moveStep; b1.x += b1.vx;
            
            // 4. 가로 반사 범위를 현재 너비에 맞게 유동적 수정
            if (b1.x < 0 || b1.x > screens.outer.clientWidth - BALL_SIZE) b1.vx *= -1;
            
            for (let j = 0; j < balls.length; j++) {
                let b2 = balls[j]; if (i === j || b2.isMelting) continue;
                let dx = b2.x - b1.x, dy = b2.y - b1.y, dist = Math.sqrt(dx*dx+dy*dy);
                if (dist < BALL_SIZE) {
                    let angle = Math.atan2(dy, dx), push = (BALL_SIZE - dist) * 0.05;
                    b1.x -= Math.cos(angle) * push; b1.y -= Math.sin(angle) * push;
                    b2.x += Math.cos(angle) * push; b2.y += Math.sin(angle) * push;
                }
            }
            b1.el.style.top = b1.y + 'px'; b1.el.style.left = b1.x + 'px';
            if (b1.y >= DEAD_LINE_Y - 5) {
                b1.isMelting = true; b1.el.classList.add('melting');
                if (b1.type === 'normal' || b1.type === 'heavy') { gameActive = false; playSound(150, 'sawtooth', 0.5); setTimeout(() => gameOver(), 600); return; }
                else { const targetBall = b1; setTimeout(() => { targetBall.el.remove(); balls = balls.filter(allB => allB !== targetBall); }, 600); }
            }
            if (b1.y > DEAD_LINE_Y - 100 && !b1.isMelting && (b1.type === 'normal' || b1.type === 'heavy')) nearDeadLine = true;
        }
        if (nearDeadLine) screens.outer.classList.add('warning-flash'); else screens.outer.classList.remove('warning-flash');
        requestAnimationFrame(update);
    }

    function togglePause() {
        isPaused = !isPaused;
        const pauseBtn = document.getElementById('pauseBtn'), homeBtn = document.getElementById('home-btn');
        if (isPaused) { pauseBtn.innerText = "RESUME"; homeBtn.style.display = "block"; if (isFever) feverEndTime -= Date.now(); }
        else { pauseBtn.innerText = "PAUSE"; homeBtn.style.display = "none"; if (isFever) feverEndTime += Date.now(); requestAnimationFrame(update); }
    }

    function quitToHome() { isPaused = false; document.getElementById('home-btn').style.display = "none"; document.getElementById('pauseBtn').innerText = "PAUSE"; gameOver(); }

    function gameOver() {
        gameActive = false; screens.outer.classList.remove('warning-flash', 'fever-active');
        saveScore(score);
        screens.ui.classList.remove('active');
        setTimeout(() => { screens.home.classList.add('active'); balls.forEach(b => b.el.remove()); balls = []; }, 500);
    }

    function resetGame() { container.querySelectorAll('.ball').forEach(el => el.remove()); balls = []; selectedBalls = []; score = 0; combo = 0; feverGauge = 0; scoreEl.innerText = '0'; feverBar.style.width = '0%'; isFever = false; spawnRate = 1600; isFrozen = false; isFoggy = false; updateSumDisplay(); }
</script>
</body>
</html>